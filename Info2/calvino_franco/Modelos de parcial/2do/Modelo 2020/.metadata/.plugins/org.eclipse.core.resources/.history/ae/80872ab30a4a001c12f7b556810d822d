/*
 * MDE_Serie.c
 *
 *  Created on: 20 nov. 2021
 *      Author: franco
 */
#include <MDE_ComunicacionSerie.h>

static int MdE_COMUNICACIONSERIE_REPOSO_SERIE (int);
static int MdE_COMUNICACIONSERIE_INICIO (int);
static int MdE_COMUNICACIONSERIE_DECIDIR_ACCION (int);
static int MdE_COMUNICACIONSERIE_COMENZAR_REINICIAR (int);
static int MdE_COMUNICACIONSERIE_DETENER (int);

static int (*MdE_COMUNICACIONSERIE[]) (int) = {

		MdE_COMUNICACIONSERIE_REPOSO_SERIE,
		MdE_COMUNICACIONSERIE_INICIO,
		MdE_COMUNICACIONSERIE_DECIDIR_ACCION,
		MdE_COMUNICACIONSERIE_COMENZAR_REINICIAR,
		MdE_COMUNICACIONSERIE_DETENER
};

static int MdE_COMUNICACIONSERIE_REPOSO_SERIE (int status)
{
	if (dato == '$')
		status = INICIO;

	return status;
}

static int MdE_COMUNICACIONSERIE_INICIO (int status)
{
	if (dato == 'M')
		status = DECIDIR_ACCION;
	else status = REPOSO_SERIE;

	return status;
}

static int MdE_COMUNICACIONSERIE_DECIDIR_ACCION (int status)
{
	if (dato == 0)
		status = DETENER;
	else if (dato == 1)
		status = COMENZAR_REINICIAR;
	else status = REPOSO_SERIE;

	return status;
}

static int MdE_COMUNICACIONSERIE_COMENZAR_REINICIAR (int status)
{
	if (dato == '#')
		accion = COMENZAR_REINICIAR_ENVIO;

	return REPOSO_SERIE;
}

static int MdE_COMUNICACIONSERIE_DETENER (int status)
{
	if (dato == '#')
		accion = DETENER_ENVIO;

	return REPOSO_SERIE;
}

void MdE_ComunicacionSerie (void)
{
	static uint8_t estado = REPOSO_SERIE;

	dato = Recibir();

	if (dato != -1) //Debo verificar que no haya error al recibir los datos
	{
		estado = (*MdE_COMUNICACIONSERIE[estado])(estado);

		if (estado < REPOSO_SERIE || estado > DETENER)
				ResetComunicacionSerie();
	}
}

