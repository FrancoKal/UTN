/*******************************************************************************************************************************//**
 *
 * @file		señales.c
 * @brief		Instala los handlers de las señales
 * @date		02-08-19
 * @author		Ing. Marcelo Tujillo 
 *
 **********************************************************************************************************************************/

/***********************************************************************************************************************************
 *** INCLUDES
 **********************************************************************************************************************************/
#include <sys/types.h>
#include <sys/wait.h>
#include <signal.h>
#include <stdlib.h>
#include <stdio.h>

#include <stdlib.h>

#include <unistd.h>
#include <string.h>
#include "señales.h"

/***********************************************************************************************************************************
 *** DEFINES PRIVADOS AL MODULO
 **********************************************************************************************************************************/

/***********************************************************************************************************************************
 *** MACROS PRIVADAS AL MODULO
 **********************************************************************************************************************************/

/***********************************************************************************************************************************
 *** TIPOS DE DATOS PRIVADOS AL MODULO
 **********************************************************************************************************************************/

/***********************************************************************************************************************************
 *** TABLAS PRIVADAS AL MODULO
 **********************************************************************************************************************************/

/***********************************************************************************************************************************
 *** VARIABLES GLOBALES PUBLICAS
 **********************************************************************************************************************************/
int salida = 0;

/***********************************************************************************************************************************
 *** VARIABLES GLOBALES PRIVADAS AL MODULO
 **********************************************************************************************************************************/

/***********************************************************************************************************************************
 *** PROTOTIPO DE FUNCIONES PRIVADAS AL MODULO
 **********************************************************************************************************************************/

void sigusr1_handler (int sig);

 /***********************************************************************************************************************************
 *** FUNCIONES PRIVADAS AL MODULO
 **********************************************************************************************************************************/

void sigusr1_handler (int sig)
{
    (void)sig;
    write (1,"Soy el handler de SIGUSR1\n",26);
    salida = 1;
    return;
}

void sigint_handler (int sig)
{
    (void)sig;
    write (1,"\nSoy el handler de SIGINT\n",25);
    return;
}

/* Es una forma de esperar a que el hijo termine para limpiar sus datos*/
void sigchld_handler(int s)
{
    (void)s;
    while ( waitpid( -1 , NULL , WNOHANG ) > 0 );
}

 /***********************************************************************************************************************************
 *** FUNCIONES GLOBALES AL MODULO
 **********************************************************************************************************************************/

int InicializarSenales( void )
{
	struct sigaction sa ;
    int salida = 1;

    sa.sa_handler = sigusr1_handler;//! handler del usuario
    sa.sa_flags = 0;
    sigemptyset(&sa.sa_mask);

    if (sigaction(SIGUSR1, &sa, NULL) == -1)
    {
        perror("sigaction");
        salida = 0;
    }

    sa.sa_handler = sigint_handler; //! handler de teclado
    sa.sa_flags = 0;
    sigemptyset(&sa.sa_mask);

    if (sigaction(SIGINT, &sa, NULL) == -1 )
    {
        perror("sigaction");
        salida = 0;
    }

    sa.sa_handler = sigchld_handler; //! handler de hijo
    sa.sa_flags = SA_RESTART;
    sigemptyset(&sa.sa_mask);

    if (sigaction(SIGCHLD, &sa, NULL) == -1 )
    {
        perror("sigaction");
        salida = 0;
    }

    return salida;
}
